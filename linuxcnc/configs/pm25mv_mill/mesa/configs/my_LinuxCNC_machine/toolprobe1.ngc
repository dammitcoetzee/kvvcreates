o<toolprobe1> SUB

; The following are initialized in toolprobe0.ngc
; #31=#1 ; Tool to load, if not already loaded.
; #32=#5422 ; Save the z-position of the current coordinate system.
; #33=0 ; Calculated tool length
; #34=#<_metric>
; #35=#<_absolute>
; #36=Reference tool length
; #<_tls_tool>=#1 ; Tool to load, if not already loaded.
; #<_tls_home_z>=#5422 ; Save the z-position of the current coordinate system.
; #<_tls_calc_tool_length>=0 ; Calculated tool length
; #<_tls_saved_metric>=#<_metric>
; #<_tls_saved_absolute>=#<_absolute>
; #<_tls_ref_len>=Reference tool length

G20 ; Inches
G49 ; Cancel tool length compensation
G91 ; Incremental mode
G94 ; Units / min feedrate

M5 M9 ; Turn off spindle and coolant.
M64 P0 ; Turn on air blast

; The G38 variants used below will stop execution and display an error 
; message if probing is not successful. Alternatively, one could use the
; non-error-signaling varieties and check #5070, which will be 1 after
; probing is successful and otherwise 0. That would provide a means to
; turn off the air blast on an error.

; Probe towards the tool length sensor, slow enough that machine can
; stop within travel of sensor. Tool length maximum approach speed
; from specification is 200mm/min.
G38.2 F[200/25.4] Z-1

; Probe away from tool length sensor, slower, in the same direction
; that home was probed, to minimize backlash error.
G38.4 F[20/25.4] Z1

M65 P0 ; Turn off air blast

G90 ; Absolute mode

; Calculate and save the length of the selected tool.
; #5063 is Z position in the coordinate system in which G38 was executed.
#<_tls_calc_tool_length> = [#<_tls_ref_len> + #<_tls_home_z> + #5063]
G10 L1 P#<_tls_tool> Z#<_tls_calc_tool_length>
G43

(debug, P32 = #<_tls_home_z>)
(debug, P36 = #<_tls_ref_len>)
(debug, P5403 = #5403)
(debug, P5063 = #5063)
(debug, T#<_tls_tool> H=#<_tls_calc_tool_length>)

G53 G0 Z0

o101 if [#<_tls_saved_metric> EQ 1]
  G21
o101 else
  G20
o101 endif

o102 if [#<_tls_saved_absolute> EQ 1]
  G90
o102 else
  G91
o102 endif

T1 M6 G43 H1

o<toolprobe1> ENDSUB [1]

M2

%
