o<toolprobe0> SUB

; The X and Y values depend on the position of the tool
; length sensor relative to home position. Edit these as
; needed to center the spindle above the sensor.
#<_tls_x_pos>=-9.5287
#<_tls_y_pos>=-1.6061

; The reference tool, e.g., the spindle nose. Edit as needed.
#<_tls_ref_tool>=99

; Define subroutine parameters.
#<_tls_tool>=#1             ; Tool to measure
#<_tls_home_z>=0            ; Z-position at home position
#<_tls_calc_tool_length>=0  ; Calculated tool length
#<_tls_ref_len>=0           ; Reference-tool length

; Save modal values to later restore.
#<_tls_s_metric>=#<_metric>
#<_tls_s_absolute>=#<_absolute>

G20 ; Inches
G49 ; Cancel tool length compensation
G90 ; Absolute mode
G94 ; Units / min feedrate

M5 M9 ; Turn off spindle and coolant.
M65 P0 ; Turn off air blast

; Move to centered above the tool length sensor.
G53 G0 Z0
G53 G0 X#<_tls_x_pos> Y#<_tls_y_pos>

#<_tls_home_z>=#5422 ; save the z-position of the current coordinate system

; Loaded requested tool, and find length of the reference tool.
; Want to avoid the extra loading of the reference tool to get length.
; Parameter #5403 returns the length of tool not the tool length offset,
; which be different, especially if setting the tool length offset to a
; different tool than the one that's loaded.
M6 T#<_tls_ref_tool> G43 H#<_tls_ref_tool>
#<_tls_ref_len>=#5403
G49

(debug, Reference tool length offset P35=P5403 = #<_tls_ref_len>)
(debug, Move tool to within .5in of tool length sensor)

o<toolprobe0> ENDSUB [1]

M2

%
