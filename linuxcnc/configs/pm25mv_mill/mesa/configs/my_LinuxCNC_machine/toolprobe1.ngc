o<toolprobe1> SUB

; This subroutine performs probes the length of the selected tool.

#<tls_tool>=#1 ; Tool to measure

; The following are initialized in toolprobe0.ngc
; #<_tls_home_z>=#5422       ; Z-position at home position
; #<_tls_s_metric>=#<_metric>
; #<_tls_s_absolute>=#<_absolute>
; #<_tls_ref_len>            ; Reference-tool length

G20 ; Inches
G49 ; Cancel tool length compensation
G91 ; Incremental mode
G94 ; Units / min feedrate

M6 T#<tls_tool>

M5 M9 ; Turn off spindle and coolant.
M64 P0 ; Turn on air blast

; The G38 variants used below will stop execution and display an error 
; message if probing is not successful. Alternatively, one could use the
; non-error-signaling varieties and check #5070, which will be 1 after
; probing is successful and otherwise 0. That would provide a means to
; turn off the air blast on an error.

; Probe towards the tool length sensor, slow enough that machine can
; stop within travel of sensor. Tool length maximum approach speed
; from specification is 200mm/min.
G38.2 F[200/25.4] Z-1

; Probe away from tool length sensor, slower, in the same direction
; that home was probed, to minimize backlash error.
G38.4 F[20/25.4] Z1

M65 P0 ; Turn off air blast

G90 ; Absolute mode

; Calculate and save the length of the selected tool.
; #5063 is Z position in the coordinate system in which G38 was executed.
#<tls_tool_length> = [#<_tls_ref_len> + #<_tls_home_z> + #5063]
G10 L1 P#<tls_tool> Z#<tls_tool_length>
G43

(debug, P32 = #<_tls_home_z>)
(debug, P36 = #<_tls_ref_len>)
(debug, P5403 = #5403)
(debug, P5063 = #5063)
(debug, T#<tls_tool> H=#<tls_tool_length>)

G53 G0 Z0

o101 if [#<_tls_s_metric> EQ 1]
  G21
o101 else
  G20
o101 endif

o102 if [#<_tls_s_absolute> EQ 1]
  G90
o102 else
  G91
o102 endif

T1 M6 G43 H1

o<toolprobe1> ENDSUB [1]

M2

%
